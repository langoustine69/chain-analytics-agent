{"version":3,"sources":["../src/paywall.ts","../src/app.ts"],"names":[],"mappings":"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","file":"index.js","sourcesContent":["import type { Hono, Context } from 'hono';\nimport { paymentMiddleware } from 'x402-hono';\nimport type { FacilitatorConfig } from 'x402/types';\nimport { z } from 'zod';\nimport type { EntrypointDef, AgentRuntime } from '@lucid-agents/types/core';\nimport type { PaymentsConfig } from '@lucid-agents/types/payments';\nimport {\n  resolvePrice,\n  validatePaymentsConfig,\n  evaluateSender,\n  findMostSpecificIncomingLimit,\n  extractSenderDomain,\n  extractPayerAddress,\n  parsePriceAmount,\n  type PaymentTracker,\n} from '@lucid-agents/payments';\n\ntype PaymentMiddlewareFactory = typeof paymentMiddleware;\n\nexport type WithPaymentsParams = {\n  app: Hono;\n  path: string;\n  entrypoint: EntrypointDef;\n  kind: 'invoke' | 'stream';\n  payments?: PaymentsConfig;\n  facilitator?: FacilitatorConfig;\n  middlewareFactory?: PaymentMiddlewareFactory;\n  runtime?: AgentRuntime;\n};\n\nexport function withPayments({\n  app,\n  path,\n  entrypoint,\n  kind,\n  payments,\n  facilitator,\n  middlewareFactory = paymentMiddleware,\n  runtime,\n}: WithPaymentsParams): boolean {\n  if (!payments) return false;\n\n  const network = entrypoint.network ?? payments.network;\n  const price = resolvePrice(entrypoint, payments, kind);\n\n  validatePaymentsConfig(payments, network, entrypoint.key);\n\n  if (!price) return false;\n  if (!payments.payTo) return false;\n  const requestSchema = entrypoint.input\n    ? z.toJSONSchema(entrypoint.input, { unrepresentable: 'any' })\n    : undefined;\n  const responseSchema = entrypoint.output\n    ? z.toJSONSchema(entrypoint.output, { unrepresentable: 'any' })\n    : undefined;\n\n  const description =\n    entrypoint.description ??\n    `${entrypoint.key}${kind === 'stream' ? ' (stream)' : ''}`;\n  const postMimeType =\n    kind === 'stream' ? 'text/event-stream' : 'application/json';\n  const inputSchema = {\n    bodyType: 'json' as const,\n    ...(requestSchema ? { bodyFields: { input: requestSchema } } : {}),\n  };\n  const outputSchema =\n    kind === 'invoke' && responseSchema\n      ? { output: responseSchema }\n      : undefined;\n\n  const resolvedFacilitator: FacilitatorConfig =\n    facilitator ??\n    ({ url: payments.facilitatorUrl } satisfies FacilitatorConfig);\n\n  const postRoute = {\n    price,\n    network,\n    config: {\n      description,\n      mimeType: postMimeType,\n      discoverable: true,\n      inputSchema,\n      outputSchema,\n    },\n  };\n\n  const getRoute = {\n    price,\n    network,\n    config: {\n      description,\n      mimeType: 'application/json',\n      discoverable: true,\n      inputSchema,\n      outputSchema,\n    },\n  };\n\n  const policyGroups = runtime?.payments?.policyGroups;\n  const paymentTracker = runtime?.payments?.paymentTracker as\n    | PaymentTracker\n    | undefined;\n\n  if (policyGroups && policyGroups.length > 0) {\n    app.use(path, async (c, next) => {\n      const senderDomain = extractSenderDomain(\n        c.req.header('origin'),\n        c.req.header('referer')\n      );\n\n      for (const group of policyGroups) {\n        if (group.blockedSenders || group.allowedSenders) {\n          const result = evaluateSender(group, undefined, senderDomain);\n          if (!result.allowed) {\n            return c.json(\n              {\n                error: {\n                  code: 'policy_violation',\n                  message: result.reason || 'Payment blocked by policy',\n                  groupName: result.groupName,\n                },\n              },\n              403\n            );\n          }\n        }\n      }\n\n      await next();\n    });\n  }\n\n  app.use(\n    path,\n    middlewareFactory(\n      payments.payTo as Parameters<PaymentMiddlewareFactory>[0],\n      {\n        [`POST ${path}`]: postRoute,\n        [`GET ${path}`]: getRoute,\n      },\n      resolvedFacilitator\n    )\n  );\n\n  if (policyGroups && policyGroups.length > 0 && paymentTracker) {\n    app.use(path, async (c, next) => {\n      await next();\n\n      const paymentResponseHeader = c.res.headers.get('X-PAYMENT-RESPONSE');\n      if (paymentResponseHeader && c.res.status >= 200 && c.res.status < 300) {\n        try {\n          const payerAddress = extractPayerAddress(paymentResponseHeader);\n          const senderDomain = extractSenderDomain(\n            c.req.header('origin'),\n            c.req.header('referer')\n          );\n          const paymentAmount = parsePriceAmount(price);\n\n          if (payerAddress && paymentAmount !== undefined) {\n            for (const group of policyGroups) {\n              if (group.incomingLimits) {\n                const limitInfo = findMostSpecificIncomingLimit(\n                  group.incomingLimits,\n                  payerAddress,\n                  senderDomain,\n                  c.req.url\n                );\n                const scope = limitInfo?.scope ?? 'global';\n\n                await paymentTracker.recordIncoming(\n                  group.name,\n                  scope,\n                  paymentAmount\n                );\n              }\n            }\n          }\n        } catch (error) {\n          console.error('[paywall] Error recording incoming payment:', error);\n        }\n      }\n    });\n  }\n\n  return true;\n}\n","import { Hono } from 'hono';\nimport { z } from 'zod';\nimport type {\n  EntrypointDef,\n  CreateAgentAppReturn,\n  AgentRuntime,\n} from '@lucid-agents/types/core';\nimport { withPayments } from './paywall';\n\nexport type CreateAgentAppOptions = {\n  /**\n   * Hook called before mounting agent routes.\n   * Use this to register custom middleware that should run before agent handlers.\n   */\n  beforeMount?: (app: Hono) => void;\n  /**\n   * Hook called after mounting all agent routes.\n   * Use this to register additional custom routes or error handlers.\n   */\n  afterMount?: (app: Hono) => void;\n};\n\nexport async function createAgentApp(\n  runtime: AgentRuntime,\n  opts?: CreateAgentAppOptions\n): Promise<CreateAgentAppReturn<Hono, AgentRuntime, AgentRuntime['agent']>> {\n  // Require HTTP extension - runtime must have handlers\n  if (!runtime.handlers) {\n    throw new Error(\n      'HTTP extension is required. Use app.use(http()) when building the runtime.'\n    );\n  }\n  const app = new Hono();\n\n  // Allow custom middleware before agent routes\n  opts?.beforeMount?.(app);\n\n  const registerEntrypointRoutes = (entrypoint: EntrypointDef) => {\n    const invokePath = `/entrypoints/${entrypoint.key}/invoke` as const;\n    const streamPath = `/entrypoints/${entrypoint.key}/stream` as const;\n\n    withPayments({\n      app,\n      path: invokePath,\n      entrypoint,\n      kind: 'invoke',\n      payments: runtime.payments?.config,\n      runtime,\n    });\n\n    app.post(invokePath, c =>\n      runtime.handlers.invoke(c.req.raw, { key: entrypoint.key })\n    );\n\n    // Always register stream route for API consistency, even if entrypoint.stream is undefined.\n    // The runtime handler will return 400 \"stream_not_supported\" if streaming isn't configured.\n    // This ensures clients get a proper error (400) rather than \"route not found\" (404).\n    // Benefits: AI agents can optimistically try streaming without querying the manifest first,\n    // then fall back to invoke on 400. This reduces round-trips and simplifies client logic.\n    withPayments({\n      app,\n      path: streamPath,\n      entrypoint,\n      kind: 'stream',\n      payments: runtime.payments?.config,\n      runtime,\n    });\n\n    app.post(streamPath, c =>\n      runtime.handlers.stream(c.req.raw, { key: entrypoint.key })\n    );\n  };\n\n  app.get('/health', c => runtime.handlers.health(c.req.raw));\n  app.get('/entrypoints', c => runtime.handlers.entrypoints(c.req.raw));\n  app.get('/.well-known/agent.json', c => runtime.handlers.manifest(c.req.raw));\n  app.get('/.well-known/agent-card.json', c =>\n    runtime.handlers.manifest(c.req.raw)\n  );\n\n  app.get('/favicon.svg', c => runtime.handlers.favicon(c.req.raw));\n\n  // Task routes (A2A Protocol task-based operations)\n  app.post('/tasks', c => runtime.handlers.tasks(c.req.raw));\n  app.get('/tasks', c => runtime.handlers.listTasks(c.req.raw));\n  app.get('/tasks/:taskId', c =>\n    runtime.handlers.getTask(c.req.raw, { taskId: c.req.param('taskId') })\n  );\n  app.post('/tasks/:taskId/cancel', c =>\n    runtime.handlers.cancelTask(c.req.raw, { taskId: c.req.param('taskId') })\n  );\n  app.get('/tasks/:taskId/subscribe', c =>\n    runtime.handlers.subscribeTask(c.req.raw, { taskId: c.req.param('taskId') })\n  );\n\n  if (runtime.handlers.landing) {\n    app.get('/', c => runtime.handlers.landing!(c.req.raw));\n  } else {\n    app.get('/', c => c.text('Landing disabled', 404));\n  }\n\n  const addEntrypoint = <\n    TInput extends z.ZodTypeAny | undefined = z.ZodTypeAny | undefined,\n    TOutput extends z.ZodTypeAny | undefined = z.ZodTypeAny | undefined,\n  >(\n    def: EntrypointDef<TInput, TOutput>\n  ): void => {\n    runtime.entrypoints.add(def);\n    const entrypoint = runtime.entrypoints\n      .snapshot()\n      .find((item: EntrypointDef) => item.key === def.key);\n    if (!entrypoint) {\n      throw new Error(`Failed to register entrypoint \"${def.key}\"`);\n    }\n    registerEntrypointRoutes(entrypoint);\n  };\n\n  for (const entrypoint of runtime.entrypoints.snapshot()) {\n    registerEntrypointRoutes(entrypoint);\n  }\n\n  // Allow custom routes and handlers after agent routes\n  opts?.afterMount?.(app);\n\n  const result: CreateAgentAppReturn<\n    Hono,\n    AgentRuntime,\n    AgentRuntime['agent']\n  > = {\n    app,\n    runtime,\n    agent: runtime.agent,\n    addEntrypoint,\n  };\n  return result;\n}\n"]}