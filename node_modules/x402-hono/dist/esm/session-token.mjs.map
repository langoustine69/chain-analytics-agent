{"version":3,"sources":["../../src/session-token.ts"],"sourcesContent":["import { generateJwt } from \"@coinbase/cdp-sdk/auth\";\nimport type { Context } from \"hono\";\n\n/**\n * Generate a session token for Coinbase Onramp and Offramp using Secure Init\n *\n * This endpoint creates a server-side session token that can be used\n * instead of passing appId and addresses directly in onramp/offramp URLs.\n *\n * Setup:\n * 1. Set CDP_API_KEY_ID and CDP_API_KEY_SECRET environment variables\n * 2. Add this to your Hono app: app.post(\"/api/x402/session-token\", POST);\n *\n * @param c - The Hono Context containing the session token request\n * @returns Promise<Response> - The response containing the session token or error\n */\nexport async function POST(c: Context) {\n  try {\n    // Get CDP API credentials from environment variables\n    const apiKeyId = process.env.CDP_API_KEY_ID;\n    const apiKeySecret = process.env.CDP_API_KEY_SECRET;\n\n    if (!apiKeyId || !apiKeySecret) {\n      console.error(\"Missing CDP API credentials\");\n      return c.json(\n        { error: \"Server configuration error: Missing CDP API credentials\" },\n        { status: 500 },\n      );\n    }\n\n    // Parse request body\n    const body = (await c.req.json()) as {\n      addresses?: Array<{ address: string; blockchains?: string[] }>;\n      assets?: string[];\n    };\n    const { addresses, assets } = body;\n\n    if (!addresses || !Array.isArray(addresses) || addresses.length === 0) {\n      return c.json(\n        { error: \"addresses is required and must be a non-empty array\" },\n        { status: 400 },\n      );\n    }\n\n    // Generate JWT for authentication\n    const jwt = await generateJwt({\n      apiKeyId,\n      apiKeySecret,\n      requestMethod: \"POST\",\n      requestHost: \"api.developer.coinbase.com\",\n      requestPath: \"/onramp/v1/token\",\n    });\n\n    // Create session token request payload\n    const tokenRequestPayload = {\n      addresses: addresses.map((addr: { address: string; blockchains?: string[] }) => ({\n        address: addr.address,\n        blockchains: addr.blockchains || [\"base\"],\n      })),\n      ...(assets && { assets }),\n    };\n\n    // Call Coinbase API to generate session token\n    const response = await fetch(\"https://api.developer.coinbase.com/onramp/v1/token\", {\n      method: \"POST\",\n      headers: {\n        Authorization: `Bearer ${jwt}`,\n        \"Content-Type\": \"application/json\",\n      },\n      body: JSON.stringify(tokenRequestPayload),\n    });\n\n    if (!response.ok) {\n      const errorText = await response.text();\n      console.error(\"Failed to generate session token:\", response.status, errorText);\n      return c.json(\n        { error: \"Failed to generate session token\" },\n        { status: response.status as 400 | 401 | 500 },\n      );\n    }\n\n    const data = (await response.json()) as Record<string, unknown>;\n\n    return c.json(data);\n  } catch (error) {\n    console.error(\"Error generating session token:\", error);\n    return c.json({ error: \"Internal server error\" }, { status: 500 });\n  }\n}\n"],"mappings":";AAAA,SAAS,mBAAmB;AAgB5B,eAAsB,KAAK,GAAY;AACrC,MAAI;AAEF,UAAM,WAAW,QAAQ,IAAI;AAC7B,UAAM,eAAe,QAAQ,IAAI;AAEjC,QAAI,CAAC,YAAY,CAAC,cAAc;AAC9B,cAAQ,MAAM,6BAA6B;AAC3C,aAAO,EAAE;AAAA,QACP,EAAE,OAAO,0DAA0D;AAAA,QACnE,EAAE,QAAQ,IAAI;AAAA,MAChB;AAAA,IACF;AAGA,UAAM,OAAQ,MAAM,EAAE,IAAI,KAAK;AAI/B,UAAM,EAAE,WAAW,OAAO,IAAI;AAE9B,QAAI,CAAC,aAAa,CAAC,MAAM,QAAQ,SAAS,KAAK,UAAU,WAAW,GAAG;AACrE,aAAO,EAAE;AAAA,QACP,EAAE,OAAO,sDAAsD;AAAA,QAC/D,EAAE,QAAQ,IAAI;AAAA,MAChB;AAAA,IACF;AAGA,UAAM,MAAM,MAAM,YAAY;AAAA,MAC5B;AAAA,MACA;AAAA,MACA,eAAe;AAAA,MACf,aAAa;AAAA,MACb,aAAa;AAAA,IACf,CAAC;AAGD,UAAM,sBAAsB;AAAA,MAC1B,WAAW,UAAU,IAAI,CAAC,UAAuD;AAAA,QAC/E,SAAS,KAAK;AAAA,QACd,aAAa,KAAK,eAAe,CAAC,MAAM;AAAA,MAC1C,EAAE;AAAA,MACF,GAAI,UAAU,EAAE,OAAO;AAAA,IACzB;AAGA,UAAM,WAAW,MAAM,MAAM,sDAAsD;AAAA,MACjF,QAAQ;AAAA,MACR,SAAS;AAAA,QACP,eAAe,UAAU,GAAG;AAAA,QAC5B,gBAAgB;AAAA,MAClB;AAAA,MACA,MAAM,KAAK,UAAU,mBAAmB;AAAA,IAC1C,CAAC;AAED,QAAI,CAAC,SAAS,IAAI;AAChB,YAAM,YAAY,MAAM,SAAS,KAAK;AACtC,cAAQ,MAAM,qCAAqC,SAAS,QAAQ,SAAS;AAC7E,aAAO,EAAE;AAAA,QACP,EAAE,OAAO,mCAAmC;AAAA,QAC5C,EAAE,QAAQ,SAAS,OAA0B;AAAA,MAC/C;AAAA,IACF;AAEA,UAAM,OAAQ,MAAM,SAAS,KAAK;AAElC,WAAO,EAAE,KAAK,IAAI;AAAA,EACpB,SAAS,OAAO;AACd,YAAQ,MAAM,mCAAmC,KAAK;AACtD,WAAO,EAAE,KAAK,EAAE,OAAO,wBAAwB,GAAG,EAAE,QAAQ,IAAI,CAAC;AAAA,EACnE;AACF;","names":[]}